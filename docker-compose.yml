services:                                                                                                     
# /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$
#|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/
# /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$
#|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/
#                                                                                                            
#                                                                                                            
#                                                                                                            
#                                                                                                            
#                                                                                                            
#             /$$$$$$$                        /$$             /$$       /$$                                  
#            | $$__  $$                      | $$            | $$      |__/                                  
#            | $$  \ $$       /$$   /$$      | $$$$$$$       | $$       /$$        /$$$$$$$                  
#            | $$$$$$$/      | $$  | $$      | $$__  $$      | $$      | $$       /$$_____/                  
#            | $$____/       | $$  | $$      | $$  \ $$      | $$      | $$      | $$                        
#            | $$            | $$  | $$      | $$  | $$      | $$      | $$      | $$                        
#            | $$            |  $$$$$$/      | $$$$$$$/      | $$      | $$      |  $$$$$$$                  
#            |__/             \______/       |_______/       |__/      |__/       \_______/                  
#                                                                                                            
#                                                                                                            
#                                                                                                            
#                                                                                                            
#                                                                                                            
# /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$
#|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/
# /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$
#|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/

  shortbus:
    build:
      context: ./shortbus
      dockerfile: Dockerfile
    ports:
      - "50051:50051"
      - "9292:9292"
    restart: unless-stopped

  gateway:
    build:
      context: ./faf-mgmt-gateway
      dockerfile: Dockerfile
    ports:
      - "1111:80"
    environment:
      - GATEWAY_SERVICE_DISCOVERY_URL_ALL=http://discovery/all
      - GATEWAY_SERVICE_DISCOVERY_URL=http://discovery
      - GATEWAY_REDIS_URI=http://gateway-cache:6379
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - CACHE_REDIS_NODES=cache-node-1:6379,cache-node-2:6379,cache-node-3:6379
    depends_on:
      discovery:
        condition: service_healthy
      cache-node-1:
        condition: service_healthy
      cache-node-2:
        condition: service_healthy
      cache-node-3:
        condition: service_healthy
  
  discovery:
    image: lumijiez/discovery:latest
    ports:
      - "2222:80"
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "3333:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'

  grafana:
    image: grafana/grafana:latest
    ports:
      - "4444:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus

  loki:
    image: grafana/loki:2.9.0
    ports:
      - "5555:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./monitoring/loki-config.yml:/etc/loki/local-config.yaml
      - loki-data:/loki

  promtail:
    image: grafana/promtail:2.9.0
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ./monitoring/promtail-config.yml:/etc/promtail/config.yml
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki

  gateway-cache:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - gateway-cache:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  cache-node-1:
    image: redis:7-alpine
    ports:
      - "6380:6379"
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - cache-node-1:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  cache-node-2:
    image: redis:7-alpine
    ports:
      - "6381:6379"
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - cache-node-2:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  cache-node-3:
    image: redis:7-alpine
    ports:
      - "6382:6379"
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - cache-node-3:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped
                                                                   
                                                                                                            
                                                                                                            
# /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$
#|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/
# /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$
#|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/
#                                                                                                            
#                                                                                                            
#                                                                                                            
#                                                                                                            
#                                                                                                            
#       /$$$$$$$                        /$$                                          /$$                     
#      | $$__  $$                      |__/                                         | $$                     
#      | $$  \ $$        /$$$$$$        /$$       /$$    /$$        /$$$$$$        /$$$$$$          /$$$$$$  
#      | $$$$$$$/       /$$__  $$      | $$      |  $$  /$$/       |____  $$      |_  $$_/         /$$__  $$ 
#      | $$____/       | $$  \__/      | $$       \  $$/$$/         /$$$$$$$        | $$          | $$$$$$$$ 
#      | $$            | $$            | $$        \  $$$/         /$$__  $$        | $$ /$$      | $$_____/ 
#      | $$            | $$            | $$         \  $/         |  $$$$$$$        |  $$$$/      |  $$$$$$$ 
#      |__/            |__/            |__/          \_/           \_______/         \___/         \_______/ 
#                                                                                                            
#                                                                                                            
#                                                                                                            
#                                                                                                            
#                                                                                                            
# /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$
#|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/
# /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$ /$$$$
#|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/|____/
                                                                                                            


# /$$$$$$$                                        /$$                       /$$
#| $$__  $$                                      |__/                      | $$
#| $$  \ $$        /$$$$$$        /$$$$$$$        /$$        /$$$$$$       | $$
#| $$  | $$       |____  $$      | $$__  $$      | $$       /$$__  $$      | $$
#| $$  | $$        /$$$$$$$      | $$  \ $$      | $$      | $$$$$$$$      | $$
#| $$  | $$       /$$__  $$      | $$  | $$      | $$      | $$_____/      | $$
#| $$$$$$$/      |  $$$$$$$      | $$  | $$      | $$      |  $$$$$$$      | $$
#|_______/        \_______/      |__/  |__/      |__/       \_______/      |__/



  lfs_postgres_primary:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_DB: lostfound-service-db
      POSTGRES_USER: ${LFS_POSTGRES_USER}
      POSTGRES_PASSWORD: ${LFS_POSTGRES_PASSWORD}
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: ${LFS_POSTGRES_PASSWORD}
    command: >
      postgres
      -c wal_level=replica
      -c max_wal_senders=3
      -c max_replication_slots=3
      -c hot_standby=on
    volumes:
      - lfs_postgres_primary_data:/var/lib/postgresql/data
      - ./init-replication.sh:/docker-entrypoint-initdb.d/init-replication.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${LFS_POSTGRES_USER} -d lostfound-service-db || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  lfs_postgres_replica1:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: ${LFS_POSTGRES_USER}
      POSTGRES_PASSWORD: ${LFS_POSTGRES_PASSWORD}
      PRIMARY_HOST: lfs_postgres_primary
      REPLICATION_SLOT: replication_slot_1
    entrypoint: /replica-entrypoint.sh
    volumes:
      - lfs_postgres_replica1_data:/var/lib/postgresql/data
      - ./replica-entrypoint.sh:/replica-entrypoint.sh:ro
    depends_on:
      lfs_postgres_primary:
        condition: service_healthy

  lfs_postgres_replica2:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: ${LFS_POSTGRES_USER}
      POSTGRES_PASSWORD: ${LFS_POSTGRES_PASSWORD}
      PRIMARY_HOST: lfs_postgres_primary
      REPLICATION_SLOT: replication_slot_2
    entrypoint: /replica-entrypoint.sh
    volumes:
      - lfs_postgres_replica2_data:/var/lib/postgresql/data
      - ./replica-entrypoint.sh:/replica-entrypoint.sh:ro
    depends_on:
      lfs_postgres_primary:
        condition: service_healthy

  lostfound:
    image: lumijiez/lostfound-service:latest
    environment:
      GATEWAY_URL: "http://gateway:80"
      DISCOVERY_URL: "http://discovery:80"
      BROKER_URL: "http://shortbus:50051"
      ConnectionStrings__DefaultConnection: "Host=lfs_postgres_primary,lfs_postgres_replica1,lfs_postgres_replica2;Port=5432;Database=lostfound-service-db;Username=${LFS_POSTGRES_USER};Password=${LFS_POSTGRES_PASSWORD};Target Session Attributes=primary"
      MONGO_URI: "mongodb://admin:admin123@datawarehouse_mongo:27017/"
      LFS_POSTGRES_USER: ${LFS_POSTGRES_USER}
      LFS_POSTGRES_PASSWORD: ${LFS_POSTGRES_PASSWORD}
    restart: always
    depends_on:
      gateway:
        condition: service_healthy
      lfs_postgres_primary:
        condition: service_healthy
      datawarehouse_mongo:
        condition: service_healthy
      shortbus:
        condition: service_started
    deploy:
      replicas: 1

  bs_postgres_primary:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_DB: budgeting-service-db
      POSTGRES_USER: ${BS_POSTGRES_USER}
      POSTGRES_PASSWORD: ${BS_POSTGRES_PASSWORD}
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: ${BS_POSTGRES_PASSWORD}
    command: >
      postgres
      -c wal_level=replica
      -c max_wal_senders=3
      -c max_replication_slots=3
      -c hot_standby=on
    volumes:
      - bs_postgres_primary_data:/var/lib/postgresql/data
      - ./init-replication.sh:/docker-entrypoint-initdb.d/init-replication.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${BS_POSTGRES_USER} -d budgeting-service-db || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  bs_postgres_replica1:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: ${BS_POSTGRES_USER}
      POSTGRES_PASSWORD: ${BS_POSTGRES_PASSWORD}
      PRIMARY_HOST: bs_postgres_primary
      REPLICATION_SLOT: replication_slot_1
    entrypoint: /replica-entrypoint.sh
    volumes:
      - bs_postgres_replica1_data:/var/lib/postgresql/data
      - ./replica-entrypoint.sh:/replica-entrypoint.sh:ro
    depends_on:
      bs_postgres_primary:
        condition: service_healthy

  bs_postgres_replica2:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: ${BS_POSTGRES_USER}
      POSTGRES_PASSWORD: ${BS_POSTGRES_PASSWORD}
      PRIMARY_HOST: bs_postgres_primary
      REPLICATION_SLOT: replication_slot_2
    entrypoint: /replica-entrypoint.sh
    volumes:
      - bs_postgres_replica2_data:/var/lib/postgresql/data
      - ./replica-entrypoint.sh:/replica-entrypoint.sh:ro
    depends_on:
      bs_postgres_primary:
        condition: service_healthy

  budgeting:
    image: lumijiez/budgeting-service:latest
    ports:
      - "5001:80"
    environment:
      GATEWAY_URL: "http://gateway:80"
      DISCOVERY_URL: "http://discovery:80"
      BROKER_URL: "http://shortbus:50051"
      ConnectionStrings__DefaultConnection: "Host=bs_postgres_primary,bs_postgres_replica1,bs_postgres_replica2;Port=5432;Database=budgeting-service-db;Username=${BS_POSTGRES_USER};Password=${BS_POSTGRES_PASSWORD};Target Session Attributes=primary"
      MONGO_URI: "mongodb://admin:admin123@datawarehouse_mongo:27017/"
      BS_POSTGRES_USER: ${BS_POSTGRES_USER}
      BS_POSTGRES_PASSWORD: ${BS_POSTGRES_PASSWORD}
    depends_on:
      gateway:
        condition: service_healthy
      bs_postgres_primary:
        condition: service_healthy
      datawarehouse_mongo:
        condition: service_healthy
      shortbus:
        condition: service_started
    restart: always
    deploy:
      replicas: 1



# /$$   /$$                         /$$                                    
#| $$  /$$/                        | $$                                    
#| $$ /$$/         /$$$$$$        /$$$$$$          /$$$$$$         /$$$$$$ 
#| $$$$$/         |____  $$      |_  $$_/         /$$__  $$       |____  $$
#| $$  $$          /$$$$$$$        | $$          | $$$$$$$$        /$$$$$$$
#| $$\  $$        /$$__  $$        | $$ /$$      | $$_____/       /$$__  $$
#| $$ \  $$      |  $$$$$$$        |  $$$$/      |  $$$$$$$      |  $$$$$$$
#|__/  \__/       \_______/         \___/         \_______/       \_______/
                                                                          
                                                                          

  tea_management:
    image: ecaterinamunteanu/tea-management-service:latest
    environment:
      GATEWAY_URL: "http://gateway:80"
      DISCOVERY_URL: "http://discovery:80"
      SHORTBUS_URL: "shortbus:50051"
      DB_HOST: tea_postgres
      DB_USER: ${TEA_POSTGRES_USER}
      DB_PASSWORD: ${TEA_POSTGRES_PASSWORD}
      DB_NAME: tea-management-db
    depends_on:
      tea_postgres:
        condition: service_healthy
      gateway:
        condition: service_healthy
      shortbus:
        condition: service_started
    restart: always
    deploy:
      replicas: 1

  tea_postgres:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${TEA_POSTGRES_USER}
      POSTGRES_PASSWORD: ${TEA_POSTGRES_PASSWORD}
      POSTGRES_DB: tea-management-db
    volumes:
      - tea-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${TEA_POSTGRES_USER} -d tea-management-db"]
      interval: 5s
      timeout: 5s
      retries: 3

  communication:
    image: ecaterinamunteanu/communication-service:latest
    environment:
      GATEWAY_URL: "http://gateway:80"
      DISCOVERY_URL: "http://discovery:80"
      SHORTBUS_URL: "shortbus:50051"
      DB_HOST: communication_postgres
      DB_USER: ${COMMUNICATION_POSTGRES_USER}
      DB_PASSWORD: ${COMMUNICATION_POSTGRES_PASSWORD}
      DB_NAME: communication-db
    depends_on:
      communication_postgres:
          condition: service_healthy
      gateway:
        condition: service_healthy
      shortbus:
        condition: service_started
    restart: always

  communication_postgres:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${COMMUNICATION_POSTGRES_USER}
      POSTGRES_PASSWORD: ${COMMUNICATION_POSTGRES_PASSWORD}
      POSTGRES_DB: communication-db
    volumes:
      - communication-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${COMMUNICATION_POSTGRES_USER} -d communication-db"]
      interval: 5s
      timeout: 5s
      retries: 5



  # /$$      /$$                                       /$$
  #| $$$    /$$$                                      |__/
  #| $$$$  /$$$$        /$$$$$$         /$$$$$$        /$$        /$$$$$$
  #| $$ $$/$$ $$       |____  $$       /$$__  $$      | $$       |____  $$
  #| $$  $$$| $$        /$$$$$$$      | $$  \__/      | $$        /$$$$$$$
  #| $$\  $ | $$       /$$__  $$      | $$            | $$       /$$__  $$
  #| $$ \/  | $$      |  $$$$$$$      | $$            | $$      |  $$$$$$$
  #|__/     |__/       \_______/      |__/            |__/       \_______/

  ums_postgres:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_DB: users
      POSTGRES_USER: ${UMS_DB_USERNAME}
      POSTGRES_PASSWORD: ${UMS_DB_PASSWORD}
    volumes:
      - ums_postgres_data:/var/lib/postgresql/data
      - ./seed/user-management-service:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${UMS_DB_USERNAME} -d users || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  user-management:
    image: mashacol/user-management-service:latest
    environment:
      NODE_ENV: ${UMS_NODE_ENV:-production}
      PORT: 3000
      DB_HOST: ums_postgres
      DB_PORT: 5432
      DB_NAME: users
      DB_USERNAME: ${UMS_DB_USERNAME}
      DB_PASSWORD: ${UMS_DB_PASSWORD}
      JWT_SECRET: ${UMS_JWT_SECRET}
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN:-}
      DISCORD_GUILD_ID: ${DISCORD_GUILD_ID:-}
      DISCORD_API_BASE_URL: "https://discord.com/api/v10"
      NOTIFICATION_SERVICE_URL: http://notification-service:3003/api/notifications
      REDIS_HOST: ums_redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      CACHE_TTL: 3600
      GATEWAY_URL: "http://gateway:80"
      DISCOVERY_URL: "http://discovery:80"
      SHORTBUS_URL: "shortbus:50051"
    depends_on:
      discovery:
        condition: service_healthy
      gateway:
        condition: service_healthy
      ums_postgres:
        condition: service_healthy
      ums_redis:
        condition: service_healthy
      shortbus:
        condition: service_started
    restart: always
    deploy:
      replicas: 1

  notification:
    image: mashacol/notification-service:latest
    environment:
      NODE_ENV: ${NS_NODE_ENV:-production}
      PORT: 3003
      REDIS_HOST: ns_redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      CACHE_TTL: 604800
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN}
      DISCORD_GUILD_ID: "1002315647956570184"
      DISCORD_CAB_CHANNEL: "1421155312345419776"
      DISCORD_API_BASE_URL: "https://discord.com/api/v10"
      GATEWAY_URL: "http://gateway:80"
      DISCOVERY_URL: "http://discovery:80"
      SHORTBUS_URL: "shortbus:50051"
    depends_on:
      discovery:
        condition: service_healthy
      gateway:
        condition: service_healthy
      ns_redis:
        condition: service_healthy
      shortbus:
        condition: service_started
    restart: always
    deploy:
      replicas: 1

  ums_redis:
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  ns_redis:
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

# /$$             /$$                       /$$                      
#| $$            |__/                      | $$                      
#| $$             /$$       /$$   /$$      | $$$$$$$         /$$$$$$ 
#| $$            | $$      | $$  | $$      | $$__  $$       |____  $$
#| $$            | $$      | $$  | $$      | $$  \ $$        /$$$$$$$
#| $$            | $$      | $$  | $$      | $$  | $$       /$$__  $$
#| $$$$$$$$      | $$      |  $$$$$$/      | $$$$$$$/      |  $$$$$$$
#|________/      |__/       \______/       |_______/        \_______/
                                                                    


  mongo-booking:
    image: mongo:7
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${BOOKING_MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${BOOKING_MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: bookingservice
    volumes:
      - mongo_booking_data:/data/db
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.runCommand({ ping: 1 }).ok' || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  booking:
    image: lewda853/fafcab-booking-service:latest
    restart: unless-stopped
    environment:
      GATEWAY_URL: "http://gateway:80"
      DISCOVERY_URL: "http://discovery:80"
      BOOKING_MONGO_URI: "mongodb://${BOOKING_MONGO_APP_USER}:${BOOKING_MONGO_APP_PASSWORD}@mongo-booking:27017/${BOOKING_MONGO_APP_DB}?authSource=admin"
      BOOKING_MONGO_DB_NAME: "${BOOKING_MONGO_APP_DB}"
      BOOKING_SERVICE_NAME: "bookingService"
      BOOKING_MAX_CONCURRENT_TASKS: "${BOOKING_MAX_CONCURRENT_TASKS}"
      BOOKING_TASK_TIMEOUT: "${BOOKING_TASK_TIMEOUT}"
      BOOKING_GOOGLE_CREDENTIALS_PATH: "/app/google-credentials.json"
      BOOKING_GOOGLE_CALENDAR_ID: "${BOOKING_GOOGLE_CALENDAR_ID}"
      TIMEZONE: "${BOOKING_TIMEZONE}"
      SHORTBUS_URL: "shortbus:50051"
    volumes:
      - ./google-credentials.json:/app/google-credentials.json:ro
    depends_on:
      gateway:
        condition: service_healthy
      mongo-booking:
        condition: service_healthy
    deploy:
      replicas: 1
  
  mongo-checkin:
    image: mongo:7
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${CHECKIN_MONGO_ROOT_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${CHECKIN_MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${CHECKIN_MONGO_APP_DB}
    volumes:
      - mongo_checkin_data:/data/db
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.runCommand({ ping: 1 }).ok' || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  checkin:
    image: lewda853/fafcab-checkin-service:latest
    restart: unless-stopped
    environment:
      GATEWAY_URL: "http://gateway:80"
      DISCOVERY_URL: "http://discovery:80"
      CHECKIN_SERVICE_NAME: "checkInService"
      CHECKIN_MONGO_URI: "mongodb://${CHECKIN_MONGO_APP_USER}:${CHECKIN_MONGO_APP_PASSWORD}@mongo-checkin:27017/${CHECKIN_MONGO_APP_DB}?authSource=admin"
      CHECKIN_MONGO_DB_NAME: "${CHECKIN_MONGO_APP_DB}"
      SHORTBUS_URL: "shortbus:50051"
    depends_on:
      gateway:
        condition: service_healthy
      mongo-checkin:
        condition: service_healthy
    deploy:
      replicas: 1



# /$$$$$$$$                       /$$                                       /$$                
#| $$_____/                      | $$                                      |__/                
#| $$              /$$$$$$       | $$       /$$   /$$        /$$$$$$$       /$$        /$$$$$$ 
#| $$$$$          /$$__  $$      | $$      | $$  | $$       /$$_____/      | $$       |____  $$
#| $$__/         | $$$$$$$$      | $$      | $$  | $$      | $$            | $$        /$$$$$$$
#| $$            | $$_____/      | $$      | $$  | $$      | $$            | $$       /$$__  $$
#| $$            |  $$$$$$$      | $$      |  $$$$$$$      |  $$$$$$$      | $$      |  $$$$$$$
#|__/             \_______/      |__/       \____  $$       \_______/      |__/       \_______/
#                                           /$$  | $$                                          
#                                          |  $$$$$$/                                          
#                                           \______/                                           



  sharing_postgres_primary:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_DB: sharing-service
      POSTGRES_USER: ${SHARING_POSTGRES_USER}
      POSTGRES_PASSWORD: ${SHARING_POSTGRES_PASSWORD}
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: ${SHARING_POSTGRES_PASSWORD}
    command: >
      postgres
      -c wal_level=replica
      -c max_wal_senders=3
      -c max_replication_slots=3
      -c hot_standby=on
    volumes:
      - sharing_postgres_primary_data:/var/lib/postgresql/data
      - ./init-replication.sh:/docker-entrypoint-initdb.d/init-replication.sh
      - ./seed/sharing-service:/docker-entrypoint-initdb.d/seed
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${SHARING_POSTGRES_USER} -d sharing-service || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  sharing_postgres_replica1:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: ${SHARING_POSTGRES_USER}
      POSTGRES_PASSWORD: ${SHARING_POSTGRES_PASSWORD}
      PRIMARY_HOST: sharing_postgres_primary
      REPLICATION_SLOT: replication_slot_1
    entrypoint: /replica-entrypoint.sh
    volumes:
      - sharing_postgres_replica1_data:/var/lib/postgresql/data
      - ./replica-entrypoint.sh:/replica-entrypoint.sh:ro
    depends_on:
      sharing_postgres_primary:
        condition: service_healthy

  sharing_postgres_replica2:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: ${SHARING_POSTGRES_USER}
      POSTGRES_PASSWORD: ${SHARING_POSTGRES_PASSWORD}
      PRIMARY_HOST: sharing_postgres_primary
      REPLICATION_SLOT: replication_slot_2
    entrypoint: /replica-entrypoint.sh
    volumes:
      - sharing_postgres_replica2_data:/var/lib/postgresql/data
      - ./replica-entrypoint.sh:/replica-entrypoint.sh:ro
    depends_on:
      sharing_postgres_primary:
        condition: service_healthy

  fr_postgres_primary:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_DB: fund-raising-service
      POSTGRES_USER: ${FR_POSTGRES_USER}
      POSTGRES_PASSWORD: ${FR_POSTGRES_PASSWORD}
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: ${FR_POSTGRES_PASSWORD}
    command: >
      postgres
      -c wal_level=replica
      -c max_wal_senders=3
      -c max_replication_slots=3
      -c hot_standby=on
    volumes:
      - fr_postgres_primary_data:/var/lib/postgresql/data
      - ./init-replication.sh:/docker-entrypoint-initdb.d/init-replication.sh
      - ./seed/fund-raising-service:/docker-entrypoint-initdb.d/seed
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${FR_POSTGRES_USER} -d fund-raising-service || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  fr_postgres_replica1:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: ${FR_POSTGRES_USER}
      POSTGRES_PASSWORD: ${FR_POSTGRES_PASSWORD}
      PRIMARY_HOST: fr_postgres_primary
      REPLICATION_SLOT: replication_slot_1
    entrypoint: /replica-entrypoint.sh
    volumes:
      - fr_postgres_replica1_data:/var/lib/postgresql/data
      - ./replica-entrypoint.sh:/replica-entrypoint.sh:ro
    depends_on:
      fr_postgres_primary:
        condition: service_healthy

  fr_postgres_replica2:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: ${FR_POSTGRES_USER}
      POSTGRES_PASSWORD: ${FR_POSTGRES_PASSWORD}
      PRIMARY_HOST: fr_postgres_primary
      REPLICATION_SLOT: replication_slot_2
    entrypoint: /replica-entrypoint.sh
    volumes:
      - fr_postgres_replica2_data:/var/lib/postgresql/data
      - ./replica-entrypoint.sh:/replica-entrypoint.sh:ro
    depends_on:
      fr_postgres_primary:
        condition: service_healthy

  sharing-service:
    image: felycianovac/sharing-service:latest
    environment:
      DB_CONNECTION: "Host=sharing_postgres_primary,sharing_postgres_replica1,sharing_postgres_replica2;Port=5432;Database=sharing-service;Username=${SHARING_POSTGRES_USER};Password=${SHARING_POSTGRES_PASSWORD};Target Session Attributes=primary"
      GATEWAY_URL: "http://gateway:80"
      DISCOVERY_URL: "http://discovery:80"
      BROKER_URL: "http://shortbus:50051"
      MONGO_URI: "mongodb://admin:admin123@datawarehouse_mongo:27017/"
      SHARING_POSTGRES_USER: ${SHARING_POSTGRES_USER}
      SHARING_POSTGRES_PASSWORD: ${SHARING_POSTGRES_PASSWORD}
    depends_on:
        gateway:
          condition: service_healthy
        sharing_postgres_primary:
          condition: service_healthy
        datawarehouse_mongo:
          condition: service_healthy
        shortbus:
          condition: service_started
    deploy:
      replicas: 1

  fund-raising-service:
    image: felycianovac/fund-raising-service:latest
    environment:
      DB_CONNECTION: "Host=fr_postgres_primary,fr_postgres_replica1,fr_postgres_replica2;Port=5432;Database=fund-raising-service;Username=${FR_POSTGRES_USER};Password=${FR_POSTGRES_PASSWORD};Target Session Attributes=primary"
      GATEWAY_URL: "http://gateway:80"
      DISCOVERY_URL: "http://discovery:80"
      BROKER_URL: "http://shortbus:50051"
      MONGO_URI: "mongodb://admin:admin123@datawarehouse_mongo:27017/"
      FR_POSTGRES_USER: ${FR_POSTGRES_USER}
      FR_POSTGRES_PASSWORD: ${FR_POSTGRES_PASSWORD}
    depends_on:
        gateway:
          condition: service_healthy
        fr_postgres_primary:
          condition: service_healthy
        datawarehouse_mongo:
          condition: service_healthy
        shortbus:
          condition: service_started
    deploy:
      replicas: 1

  # Data Warehouse
  datawarehouse_mongo:
    image: mongo:7
    restart: always
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
    volumes:
      - datawarehouse_mongo_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  # Common Services
  prometheus-data:
  grafana-data:
  loki-data:
  gateway-cache:
    driver: local
  cache-node-1:
    driver: local
  cache-node-2:
    driver: local
  cache-node-3:
    driver: local
  shortbus-data:
    driver: local  

  ums_postgres_data:
  lfs_postgres_primary_data:
  lfs_postgres_replica1_data:
  lfs_postgres_replica2_data:
  bs_postgres_primary_data:
  bs_postgres_replica1_data:
  bs_postgres_replica2_data:
  sharing_postgres_primary_data:
  sharing_postgres_replica1_data:
  sharing_postgres_replica2_data:
  fr_postgres_primary_data:
  fr_postgres_replica1_data:
  fr_postgres_replica2_data:
  tea-data:
  communication-data:
  mongo_booking_data:
  mongo_checkin_data:
  datawarehouse_mongo_data:
