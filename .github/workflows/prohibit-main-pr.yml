name: Branch Policy Check

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
    branches:
      - main
      - dev

permissions:
  contents: read
  issues: write
  pull-requests: write
  statuses: write

jobs:
  check-branch-policy:
    runs-on: ubuntu-latest
    steps:
      - name: Check branch policy
        run: |
          echo "Checking PR branch policy..."
          echo "PR target branch: ${{ github.base_ref }}"
          echo "PR source branch: ${{ github.head_ref }}"
          echo "PR number: ${{ github.event.number }}"
          echo "PR title: ${{ github.event.pull_request.title }}"
          echo ""
          
          # Check if PR is to main
          if [ "${{ github.base_ref }}" == "main" ]; then
            if [ "${{ github.head_ref }}" != "dev" ]; then
              echo "ERROR: Branch Policy Violation for MAIN"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "Pull requests to 'main' must come from the 'dev' branch"
              echo ""
              echo "Current source branch: ${{ github.head_ref }}"
              echo "Expected source branch: dev"
              echo ""
              echo "ğŸ“‹ Required Actions:"
              echo "1. Close this PR"
              echo "2. PR your changes into 'dev' first"
              echo "3. Create a new PR from 'dev' to 'main'"
              echo ""
              echo "This policy ensures all changes go through proper review"
              echo "and testing in the dev branch before reaching main."
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 1
            else
              echo "SUCCESS: PR to main from dev - Policy compliant"
            fi
          # Check if PR is to dev
          elif [ "${{ github.base_ref }}" == "dev" ]; then
            if [ "${{ github.head_ref }}" == "main" ]; then
              echo "ERROR: Branch Policy Violation for DEV"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "Pull requests from 'main' to 'dev' are not allowed"
              echo "This would create a reverse flow in our branching strategy"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 1
            else
              echo "SUCCESS: Feature branch to dev - Policy compliant"
              echo "Feature branch '${{ github.head_ref }}' can merge into dev"
            fi
          fi

      - name: Add comment on failure (with PAT)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          if [ "${{ github.base_ref }}" == "main" ]; then
            COMMENT="**Branch Policy Check Failed**\n\nThis pull request is targeting the \`main\` branch but is coming from \`${{ github.head_ref }}\`.\n\n**Required:** All pull requests to \`main\` must come from the \`dev\` branch.\n\n**Please:**\n1. Close this PR\n2. Merge your changes into \`dev\` first\n3. Create a new PR from \`dev\` to \`main\`\n\n---\n*This check ensures our branching strategy is followed correctly.*"
          else
            COMMENT="**Branch Policy Check Failed**\n\nInvalid branch configuration detected.\n\nPlease check the source and target branches and try again."
          fi
          
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.number }}/comments \
            -d "{\"body\": \"$COMMENT\"}" || echo "Could not add comment (check PAT_TOKEN permissions)"
