name: Check PR Base Branch

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
    branches:
      - main

jobs:
  check-base-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR base is dev
        run: |
          echo "Checking PR branch policy..."
          echo "PR target branch: ${{ github.base_ref }}"
          echo "PR source branch: ${{ github.head_ref }}"
          echo "PR number: ${{ github.event.number }}"
          echo "PR title: ${{ github.event.pull_request.title }}"
          
          if [ "${{ github.head_ref }}" != "dev" ]; then
            echo ""
            echo "ERROR: Branch Policy Violation"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Pull requests to 'main' must come from the 'dev' branch"
            echo ""
            echo "Current source branch: ${{ github.head_ref }}"
            echo "Expected source branch: dev"
            echo ""
            echo "📋 Required Actions:"
            echo "1. Close this PR"
            echo "2. PR your changes into 'dev' first"
            echo "3. Create a new PR from 'dev' to 'main'"
            echo ""
            echo "This policy ensures all changes go through proper review"
            echo "and testing in the dev branch before reaching main."
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            exit 1
          else
            echo ""
            echo "SUCCESS: Branch Policy Check Passed"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "PR is correctly coming from 'dev' branch"
            echo "Proceeding with normal PR process..."
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          fi

      - name: Add comment on failure (with PAT)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.number }}/comments \
            -d '{
              "body": "**Branch Policy Check Failed**\n\nThis pull request is targeting the `main` branch but is coming from `${{ github.head_ref }}`.\n\n**Required:** All pull requests to `main` must come from the `dev` branch.\n\n**Please:**\n1. Close this PR\n2. Merge your changes into `dev` first\n3. Create a new PR from `dev` to `main`\n\n---\n*This check ensures our branching strategy is followed correctly.*"
            }' || echo "Could not add comment (check PAT_TOKEN permissions)"
